---
import Layout from '../../layouts/Base.astro';
import type { SanityDocument } from '@sanity/client';
import { sanityClient } from 'sanity:client';
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';
import PortableTextRenderer from '../../components/PortableTextRenderer.astro';

const WORK_QUERY = `*[_type == "work" && slug.current == $slug][0]{
  ...,
  body[] {
    _type,
    _type == "imageBlock" => {
      heading,
      image,
      caption,
      dark
    },
    _type == "textBlock" => {
      heading,
      content,
      dark
    },
    _type == "gridBlock" => {
      heading,
      columns,
      items[] {
        type,
        content,
        image,
        subtitle,
        caption
      },
      dark
    }
  }
}`;

const work = await sanityClient.fetch<SanityDocument>(WORK_QUERY, Astro.params);

export async function getStaticPaths() {
  const SLUGS_QUERY = `*[_type == "work" && defined(slug.current)]{
    "params": {"slug": slug.current}
  }`;
  return await sanityClient.fetch(SLUGS_QUERY);
}

const { projectId, dataset } = sanityClient.config();
const urlFor = (source: SanityImageSource) =>
  projectId && dataset ? imageUrlBuilder({ projectId, dataset }).image(source) : null;
const workImageUrl = work.image ? urlFor(work.image)?.width(1600).height(900).url() : null;
---

<Layout>
  <!-- ── HERO ──────────────────────────────────────────────── -->
  <section class="container-custom-small">
    <!-- hero image -->
    <div class="img-container h-[50vh] w-full overflow-hidden">
      <img
        src={workImageUrl || ''}
        alt={work.image?.alt || ''}
        class="h-full w-full object-cover"
        style="filter: grayscale(15%) contrast(1.05);"
      />
    </div>

    <!-- tags -->
    <div class="border-light flex items-center gap-6 border-b py-3">
      {work.tags && work.tags.map((tag: string) => <span class="tiny-text">{tag}</span>)}
    </div>

    <!-- headline + details -->
    <div class="grid grid-cols-1 md:grid-cols-3">
      <!-- headline -->
      <div class="border-light border-r py-10 pr-10 md:col-span-2">
        <h1 class="font-light tracking-tight">{work.headline}</h1>
      </div>

      <!-- details -->
      <div class="flex flex-col gap-5 py-10 pl-10 text-sm md:col-span-1">
        <div>
          <p class="tiny-text mb-1">Company</p>
          <p class="">{work.title}</p>
        </div>
        <div>
          <p class="tiny-text mb-1">Role</p>
          <p class="">{work.role}</p>
        </div>
        <div>
          <p class="tiny-text mb-1">Timeline</p>
          <p class="">{work.timeline}</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ── BODY ───────────────────────────────────────── -->
  <section class="mt-20 flex flex-col gap-20">
    {
      work.body &&
        work.body.map((block: any, index: number) => {
          const blockClass = block.dark
            ? 'container-custom-small bg-dark py-20 text-white'
            : 'container-custom-small text-dark';
          const blockHeaderClass = block.dark
            ? 'mb-2 flex items-baseline gap-6 text-white'
            : 'mb-2 flex items-baseline gap-6';
          const borderClass = 'border-light mb-6';
          const num = String(index + 1).padStart(2, '0');

          /* ── IMAGE BLOCK ── */
          if (block._type === 'imageBlock') {
            const imageUrl = block.image ? urlFor(block.image)?.width(1200).url() : null;
            return (
              <div class={blockClass}>
                <div class={blockHeaderClass}>
                  <span class="text-accent">{num}</span>
                  {block.heading && <h3 class="">{block.heading}</h3>}
                </div>

                <hr class={borderClass} />

                {imageUrl && (
                  <figure>
                    <div class="img-container">
                      <img src={imageUrl} alt={block.image?.alt || ''} class="w-full" />
                    </div>
                    {block.caption && <figcaption>{block.caption}</figcaption>}
                  </figure>
                )}
              </div>
            );

            /* ── TEXT BLOCK ── */
          } else if (block._type === 'textBlock') {
            return (
              <div class={blockClass}>
                <div class={blockHeaderClass}>
                  <span class="text-accent">{num}</span>
                  {block.heading && <h3>{block.heading}</h3>}
                </div>

                <hr class={borderClass} />

                <div class="grid grid-cols-1 gap-10 md:grid-cols-12">
                  {block.heading && (
                    <div class="md:col-span-3">
                      <p class="tiny-text">{block.heading}</p>
                    </div>
                  )}
                  {block.content && (
                    <div class={block.heading ? 'md:col-span-9' : 'md:col-span-12'}>
                      {/* block body */}
                      <div class="text-sm leading-relaxed font-light">
                        <PortableTextRenderer value={block.content} />
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );

            /* ── GRID BLOCK ── */
          } else if (block._type === 'gridBlock') {
            const colMap = {
              '2': 'grid-cols-1 md:grid-cols-2',
              '3': 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3',
              '4': 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4',
            };

            return (
              <div class={blockClass}>
                <div class={blockHeaderClass}>
                  <span class="text-accent">{num}</span>
                  {block.heading && <h3 class="">{block.heading}</h3>}
                </div>

                <hr class={borderClass} />
                {/* grid */}
                <div
                  class={`grid gap-4 ${colMap[block.columns as '2' | '3' | '4'] || 'grid-cols-1'}`}
                >
                  {block.items &&
                    block.items.map((item: any) => (
                      // grid item
                      <div class="">
                        {item.subtitle && <p class="tiny-text mb-4">{item.subtitle}</p>}

                        {item.type === 'image' && item.image && (
                          <figure>
                            <div class="img-container">
                              <img
                                src={urlFor(item.image)?.width(600).url() || ''}
                                alt={item.image.alt || ''}
                                class="w-full"
                              />
                            </div>
                            {item.caption && <figcaption>{item.caption}</figcaption>}
                          </figure>
                        )}

                        {item.type === 'text' && item.content && (
                          // block body
                          <div class="text-sm leading-relaxed font-light">
                            <PortableTextRenderer value={item.content} />
                            {item.caption && <p class="mt-4 text-left">{item.caption}</p>}
                          </div>
                        )}
                      </div>
                    ))}
                </div>
              </div>
            );
          }

          return null;
        })
    }
  </section>
</Layout>
