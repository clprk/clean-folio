---
import Layout from '../../layouts/Base.astro';
import type { SanityDocument } from '@sanity/client';
import { sanityClient } from 'sanity:client';
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';
import PortableTextRenderer from '../../components/PortableTextRenderer.astro';

const WORK_QUERY = `*[_type == "work" && slug.current == $slug][0]{
  ...,
  body[] {
    _type,
    _type == "imageBlock" => {
      heading,
      image,
      caption,
      dark
    },
    _type == "textBlock" => {
      heading,
      content,
      dark,
      header
    },
    _type == "gridBlock" => {
      heading,
      columns,
      items[] {
        type,
        content,
        image,
        subtitle,
        caption
      },
      dark
    }
  }
}`;

const work = await sanityClient.fetch<SanityDocument>(WORK_QUERY, Astro.params);

export async function getStaticPaths() {
  const SLUGS_QUERY = `*[_type == "work" && defined(slug.current)]{
    "params": {"slug": slug.current}
  }`;
  return await sanityClient.fetch(SLUGS_QUERY);
}

const { projectId, dataset } = sanityClient.config();
const urlFor = (source: SanityImageSource) =>
  projectId && dataset ? imageUrlBuilder({ projectId, dataset }).image(source) : null;
const workImageUrl = work.image ? urlFor(work.image)?.width(1600).height(900).url() : null;

let headerCount = 0;
---

<Layout>
  <!-- ── HERO ──────────────────────────────────────────────── -->
  <section class="container-custom-small">
    <!-- tags -->
    <div class="flex items-center gap-2 py-3">
      {
        work.tags?.map((tag: string, i: number) => (
          <span class="tiny-text">
            {tag}
            {i < work.tags.length - 1 && '✦'}
          </span>
        ))
      }
    </div>

    <!-- headline + details -->
    <div class="border-light grid grid-cols-1 border-t md:grid-cols-2">
      <!-- headline -->
      <div class="border-light border-r py-10 pr-3 md:col-span-1">
        <h1 class="">{work.headline}</h1>
      </div>

      <!-- details -->
      <div class="flex flex-col gap-5 py-6 pl-3 text-sm md:col-span-1">
        <!-- <div>
          <p class="tiny-text mb-1">Company</p>
          <p class="">{work.title}</p>
        </div>
        <div>
          <p class="tiny-text mb-1">Role</p>
          <p class="">{work.role}</p>
        </div>
        <div>
          <p class="tiny-text mb-1">Timeline</p>
          <p class="">{work.timeline}</p>
        </div> -->
        <div>
          <p class="tiny-text mb-1">Summary</p>
          <p>{Array.isArray(work.summary) && <PortableTextRenderer value={work.summary} />}</p>
        </div>
        <!-- details -->
        <!-- <div class="flex justify-between text-sm md:col-span-1">
          <div>
            <p class="tiny-text mb-1">Company</p>
            <p class="">{work.title}</p>
          </div>
          <div>
            <p class="tiny-text mb-1">Role</p>
            <div class="">{work.role.map((r: string) => <p>{r}</p>)}</div>
          </div>
          <div>
            <p class="tiny-text mb-1">Timeline</p>
            <p class="">{work.timeline}</p>
          </div>
        </div> -->
      </div>
    </div>
    <!-- details -->
    <div class="border-light flex grid grid-cols-1 justify-between border-t text-sm md:grid-cols-2">
      <div class="border-light border-r py-6 pr-3">
        <p class="tiny-text mb-1">Company</p>
        <p class="">{work.title}</p>
      </div>
      <div class="grid grid-cols-2 gap-3 py-6 pl-3">
        <div>
          <p class="tiny-text mb-1">Role</p>
          <div class="">{work.role.map((r: string) => <p>{r}</p>)}</div>
        </div>
        <div>
          <p class="tiny-text mb-1">Timeline</p>
          <p class="">{work.timeline}</p>
        </div>
      </div>
    </div>

    <!-- hero image -->
    <div class="img-container mt-6 h-[50vh] w-full overflow-hidden">
      <img
        src={workImageUrl || ''}
        alt={work.image?.alt || ''}
        class="h-full w-full object-cover"
        style="filter: grayscale(15%) contrast(1.05);"
      />
    </div>
  </section>

  <!-- ── BODY ───────────────────────────────────────── -->
  <section class="mt-20 flex flex-col gap-20">
    {
      work.body &&
        work.body.map((block: any, index: number) => {
          const isDark = block.dark;
          const isHeader = block.header;
          const hasHeading = !!block.heading;

          const headerIndex = isHeader ? ++headerCount : null;

          const containerClass = [isDark ? 'bg-dark py-20 text-white' : '', isHeader ? 'mt-10' : '']
            .filter(Boolean)
            .join(' ');

          const headerRowClass = [
            isDark ? 'text-white' : 'text-dark',
            isHeader ? 'mb-2 flex items-start gap-6' : 'grid grid-cols-1 gap-10 md:grid-cols-12',
          ].join(' ');

          const borderClass = 'border-light mb-6';
          const num = headerIndex ? String(headerIndex).padStart(2, '0') : null;

          /* ── TEXT BLOCK ── */
          if (block._type === 'textBlock') {
            const isSectionHeader = isHeader;

            return (
              <div class={containerClass}>
                <div class="container-custom-small">
                  {isSectionHeader && <hr class={borderClass} />}

                  {isSectionHeader ? (
                    /* ── HEADER STYLE TEXT BLOCK ── */
                    <>
                      <div class={headerRowClass}>
                        <span class="text-accent small-text mt-1 leading-none">{num}</span>
                        {hasHeading && <h2 class="leading-none">{block.heading}</h2>}
                      </div>

                      {block.content && <PortableTextRenderer value={block.content} />}
                    </>
                  ) : (
                    /* ── STANDARD TEXT BLOCK ── */

                    <div class={headerRowClass}>
                      {hasHeading && (
                        <div class="md:col-span-3">
                          <h3 class={isDark ? 'text-white' : 'text-dark'}>{block.heading}</h3>
                        </div>
                      )}

                      {block.content && (
                        <div
                          class={[
                            hasHeading ? 'md:col-span-9' : 'md:col-span-12',
                            isDark ? 'text-white' : 'text-gray',
                          ]
                            .filter(Boolean)
                            .join(' ')}
                        >
                          <PortableTextRenderer value={block.content} />
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            );

            /* ── IMAGE BLOCK ── */
          } else if (block._type === 'imageBlock') {
            const imageUrl = block.image ? urlFor(block.image)?.width(1200).url() : null;
            return (
              <div class="container-custom-small">
                <div class={headerRowClass}>
                  {block.heading && <h3 class="md:col-span-12">{block.heading}</h3>}
                </div>

                {imageUrl && (
                  <figure>
                    <div class="img-container">
                      <img src={imageUrl} alt={block.image?.alt || ''} class="w-full" />
                    </div>
                    {block.caption && <figcaption>{block.caption}</figcaption>}
                  </figure>
                )}
              </div>
            );

            /* ── GRID BLOCK ── */
          } else if (block._type === 'gridBlock') {
            const colMap = {
              '2': 'grid-cols-1 md:grid-cols-2',
              '3': 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3',
              '4': 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4',
            };

            return (
              <div class="container-custom-small">
                <div class={headerRowClass}>
                  {block.heading && <h3 class="md:col-span-12">{block.heading}</h3>}
                </div>

                {/* <hr class={borderClass} /> */}

                {/* grid */}
                <div
                  class={`grid gap-4 ${colMap[block.columns as '2' | '3' | '4'] || 'grid-cols-1'}`}
                >
                  {block.items &&
                    block.items.map((item: any) => (
                      // grid item
                      <div class="">
                        {item.subtitle && <p class="small-text mb-4">{item.subtitle}</p>}

                        {item.type === 'image' && item.image && (
                          <figure>
                            <div class="img-container">
                              <img
                                src={urlFor(item.image)?.width(600).url() || ''}
                                alt={item.image.alt || ''}
                                class="w-full"
                              />
                            </div>
                            {item.caption && <figcaption>{item.caption}</figcaption>}
                          </figure>
                        )}

                        {item.type === 'text' && item.content && (
                          // block body
                          <div>
                            <PortableTextRenderer value={item.content} />
                            {item.caption && <p class="mt-4 text-left">{item.caption}</p>}
                          </div>
                        )}
                      </div>
                    ))}
                </div>
              </div>
            );
          }

          return null;
        })
    }
  </section>
</Layout>
